#!/usr/bin/env groovy

//String PYTHON_DOCKER_IMAGE = 'docker.io/dwolla/jenkins-agent-python:latest'
String PYTHON_DOCKER_IMAGE = 'psuswestha1.jfrogrt.net/athenahealth/athenahealth/cd/docker-ubuntu_ubuntubase:master-1.0.0-a85511c-20220912174402'

node('us-staging-jenkins')
{


      docker.image(PYTHON_DOCKER_IMAGE).inside()
      {

            def server = Artifactory.server SERVER_ID
            def rtPip = Artifactory.newPipBuild()
            def buildInfo
            sh 'mkdir -p ./venv'
            sh 'virtualenv -p /usr/bin/python3 ./venv'
            def virtual_env_activation = ". ./venv/bin/activate"
            //def virtual_env_activation = ". /Users/sureshv/PycharmProjects/my_virtual_env/bin/activate" // pip virtual-environment activation command

            stage ('Clone') {
                git url: 'https://github.com/jfrog/project-examples.git'
            }

            stage ('Artifactory configuration') {
                rtPip.resolver repo: PIP_RESOLVER , server: server
                buildInfo = Artifactory.newBuildInfo()
                buildInfo.project = 'proj1'
            }

            stage ('Pip install') {
		echo 'in rtPip.install' 
		sh '''
		    ls -al "$(pip cache dir)"
		    apt-get install -y python3-pip
		    ls -al "$(pip cache dir)"
                    #rm -d -r "$(pip cache dir)"
                    python3 -m pip install -upgrade pip
                    python3 -m pip cache purge 
		    ls -al "$(pip cache dir)"
                '''    
                rtPip.install buildInfo: buildInfo, args: "-r python-example/pip-example/requirements.txt --no-cache-dir --force-reinstall ", envActivation: virtual_env_activation
                sh 'cat "/var/jenkins_slave/workspace/PyPI Build Scripted Pipeline/.jfrog/projects/deps.cache.json"'
                
                if (buildInfo.getDependencies().size() > 0) {
                    def localPath = buildInfo.getDependencies()[0].getLocalPath()
                    def remotePath = buildInfo.getDependencies()[0].getRemotePath()
                    def md5 = buildInfo.getDependencies()[0].getMd5()
                    def sha1 = buildInfo.getDependencies()[0].getSha1()

                    echo localPath
                    echo remotePath
                }
                  // sleep 300
            }

            stage ('Package and create distribution archives') {
                sh '''
                    $virtual_env_activation
                    cd python-example/pip-example
                    python3 setup.py sdist
                '''
            }

            stage ('Upload packages') {
                def uploadSpec = """{
                    "files": [
                        {
                            "pattern": "python-example/pip-example/dist/",
                            "target": "proj1-pypi-virtual/"
                        }
                    ]
                }""" 

                server.upload buildInfo: buildInfo, spec: uploadSpec
  
            }

            stage ('Publish build info') {
                    echo 'In Publish build info' 
                    echo buildInfo.toString()
                    if (buildInfo.getDependencies().size() > 0) {
                    def localPath = buildInfo.getDependencies()[0].getLocalPath()
                    def remotePath = buildInfo.getDependencies()[0].getRemotePath()
                    def md5 = buildInfo.getDependencies()[0].getMd5()
                    def sha1 = buildInfo.getDependencies()[0].getSha1()

                    echo localPath
                }
                if (buildInfo.getDependencies().size() == 0) {
                   echo 'buildInfo is empty before publishBuildInfo !!!' 

                }
                sh 'cat "/var/jenkins_slave/workspace/PyPI Build Scripted Pipeline/.jfrog/projects/deps.cache.json"'
                server.publishBuildInfo buildInfo
                echo 'Published the buildInfo' 
                //sleep 600
            }
            stage ('Xray scan') {
		       def scanConfig = [
		    'buildName'      : buildInfo.name,
		    'buildNumber'    : buildInfo.number,
		     // Only if this build is associated with a project in Artifactory, set the project key as follows.
		    'project'        : 'proj1',
		    'failBuild'      : false
		  ]
		        def scanResult = server.xrayScan scanConfig
		       
		}
      }


}
